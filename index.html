<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤í˜ì´ ì†¡ê¸ˆ ë° ì»¤í”¼ ë‚´ê¸° ê´€ë¦¬</title>
    
    <link rel="icon" href="https://drive.google.com/uc?export=view&id=18utCRt0LXOtXjkjMmLeBDeGGb_px9xPW">
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=18utCRt0LXOtXjkjMmLeBDeGGb_px9xPW">
    
    <style>
        body { 
            font-family: 'Malgun Gothic', 'Arial', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding-top: 40px; 
            padding-bottom: 40px; 
            background-color: #f0f0f0; 
        }
        .app-title {
            font-size: 2.2em;
            color: #1a1a1a;
            margin-bottom: 40px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            padding: 10px 20px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            letter-spacing: -0.5px;
        }
        .instruction {
            margin-bottom: 30px;
            font-size: 1.1em;
            color: #555;
            text-align: center;
        }
        
        /* --- íƒ­ ê´€ë ¨ CSS ì¶”ê°€ --- */
        .tabs-container {
            width: 90%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            margin: 0 2px;
            border: none;
            border-bottom: 3px solid transparent;
            background-color: #f9f9f9;
            color: #555;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
        }
        .tab-button:hover {
            background-color: #eee;
        }
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 3px solid #FEE500;
            color: #1a1a1a;
        }
        
        .section-container {
            width: 90%;
            max-width: 400px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px; 
        }
        .person-button {
            background-color: #FEE500; 
            color: #191919;
            border: none;
            padding: 20px 40px;
            margin: 10px 0;
            text-align: center;
            text-decoration: none;
            display: block;
            font-size: 18px;
            cursor: pointer;
            border-radius: 12px;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.1s;
        }
        .person-button:hover {
            background-color: #ffd400;
            transform: translateY(-2px);
        }
        .calculator-section h3, .record-section h3, .stats-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.3em;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }
        #recordBuyerCheckboxes {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto; 
        }
        #recordBuyerCheckboxes label {
            font-weight: normal;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        #recordBuyerCheckboxes input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        #calculateButton, #saveRecordButton, .delete-button {
            background-color: #555; 
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        #calculateButton:hover, #saveRecordButton:hover, .delete-button:hover {
            background-color: #333;
        }
        #calculationResult {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #FEE500; 
            background-color: #fffde0; 
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            min-height: 50px;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #calculationResult small {
             font-size: 0.8em;
             font-weight: normal;
             color: #777;
             margin-top: 5px;
        }
        #recordsList {
            list-style: none;
            padding: 0;
        }
        #recordsList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        #recordsList li strong {
            color: #333;
        }
        .delete-button {
            width: 60px;
            padding: 8px;
            margin: 0;
            background-color: #e74c3c;
            font-size: 0.8em;
        }
        .delete-button:hover {
            background-color: #c0392b;
        }
        .stats-chart {
            margin-bottom: 30px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .stats-chart h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: #444;
            margin-bottom: 15px;
        }
        .chart-bar-container {
            background-color: #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .chart-bar {
            height: 25px;
            line-height: 25px;
            color: white;
            text-align: right;
            padding-right: 5px;
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            transition: width 0.5s ease-out;
        }
        .chart-bar.regular { background-color: #2ecc71; } 
        .chart-bar.extra { background-color: #f1c40f; } 
        .chart-bar.buyer-all { background-color: #3498db; } 
        .chart-bar.buyer-regular { background-color: #1abc9c; } 
        .chart-bar.buyer-extra { background-color: #f39c12; } 
        #latestRegularBuyer {
            padding: 15px;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        /* ê¸°ì¡´ .tab-content ìŠ¤íƒ€ì¼ ìˆ˜ì •: ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ */
        .tab-content {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            width: 100%;
            align-items: center;
            flex-direction: column;
        }
        .tab-content.active {
            display: flex; /* í™œì„±í™” ì‹œ í‘œì‹œ */
        }
    </style>
</head>
<body>

    <h1 class="app-title">ğŸ’¸ ì†¡ê¸ˆ ë° ì»¤í”¼ ë‚´ê¸° ê´€ë¦¬ ì›¹ ì•± â˜•</h1>
    
    <div class="tabs-container">
        <button class="tab-button active" onclick="openTab('calcContent', this)">ê³„ì‚°/ì†¡ê¸ˆ</button>
        <button class="tab-button" onclick="openTab('recordContent', this)">ê¸°ë¡í•˜ê¸°</button>
        <button class="tab-button" onclick="openTab('statsContent', this)">í†µê³„</button>
    </div>
    <div id="calcContent" class="tab-content active"> 
        <p class="instruction">ë”ì¹˜í˜ì´ ê¸ˆì•¡ì„ í™•ì¸í•˜ê³ , ì•„ë˜ì—ì„œ ì†¡ê¸ˆí•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”.</p>

        <div class="section-container calculator-section">
            <h3>ğŸ’¸ ë”ì¹˜í˜ì´ ê³„ì‚°ê¸° (100ì› ë‹¨ìœ„ ì˜¬ë¦¼ ê¸°ì¤€)</h3>
            <div class="input-group">
                <label for="totalAmount">ì´ ê¸ˆì•¡ (ì›)</label>
                <input type="number" id="totalAmount" placeholder="ì´ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)">
            </div>
            <div class="input-group">
                <label for="numPeople">ë‚˜ëˆ ì•¼ í•  ì¸ì› (ëª…)</label>
                <input type="number" id="numPeople" placeholder="ë‚˜ëˆ ì•¼ í•  ì¸ì›ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)">
            </div>
            <button id="calculateButton" onclick="calculateSplit()">ê³„ì‚°í•˜ê¸°</button>
            <div id="calculationResult">
                ê²°ê³¼ë¥¼ ë³´ë ¤ë©´ 'ê³„ì‚°í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
        </div>

        <div class="section-container">
            <h3>ğŸ’³ ì¹´ì¹´ì˜¤í˜ì´ ì†¡ê¸ˆ ë°”ë¡œê°€ê¸°</h3>
            <button class="person-button" onclick="goToKakaopay('êµ¬ë³´ëŒ')">êµ¬ë³´ëŒ</button>
            <button class="person-button" onclick="goToKakaopay('ê¹€í˜œë¹ˆ')">ê¹€í˜œë¹ˆ</button>
            <button class="person-button" onclick="goToKakaopay('ë°•ì„œì—°')">ë°•ì„œì—°</button>
            <button class="person-button" onclick="goToKakaopay('ë°•ì„±í¬')">ë°•ì„±í¬</button>
            <button class="person-button" onclick="goToKakaopay('ì •ë¯¼ê²½')">ì •ë¯¼ê²½</button>
            <button class="person-button" onclick="goToKakaopay('ì •ì§€í¬')">ì •ì§€í¬</button>
            <button class="person-button" onclick="goToKakaopay('í™©ë¯¼êµ¬')">í™©ë¯¼êµ¬</button>
        </div>
    </div>
    
    <div id="recordContent" class="tab-content">
        <div class="section-container record-section">
            <h3>âœï¸ ë‚´ê¸° ê¸°ë¡í•˜ê¸°</h3>
            <div class="input-group">
                <label for="recordType">1. ê²Œì„ êµ¬ë¶„</label>
                <select id="recordType">
                    <option value="ì •ê·œ">ì •ê·œ (ëª¨ë‘ í•¨ê»˜í•œ ê²Œì„)</option>
                    <option value="ë²ˆì™¸" selected>ë²ˆì™¸ (ì¼ë¶€ë§Œ í•œ ê²Œì„)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="recordDate">2. ë‚ ì§œ</label>
                <input type="date" id="recordDate" value="">
            </div>
            <div class="input-group">
                <label>3. ì»¤í”¼ êµ¬ë§¤ì (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
                <div id="recordBuyerCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    </div>
            </div>
            <div class="input-group">
                <label for="recordGame">4. ë¬´ìŠ¨ ê²Œì„?</label>
                <input type="text" id="recordGame" placeholder="ì˜ˆ: ë³µë¶ˆë³µ ë½‘ê¸°, ì‚¬ë‹¤ë¦¬íƒ€ê¸°">
            </div>
            <button id="saveRecordButton" onclick="saveRecord()">ê¸°ë¡ ì €ì¥ (í´ë¼ìš°ë“œ/Firebase)</button>
        </div>

        <div class="section-container record-list-section">
            <h3>ğŸ—‘ï¸ ê¸°ë¡ ëª©ë¡ ë° ì‚­ì œ</h3>
            <ul id="recordsList">
                </ul>
        </div>
    </div>

    <div id="statsContent" class="tab-content">
        <div class="section-container stats-section">
            <h3>ğŸ“Š í†µê³„</h3>

            <div id="latestRegularBuyer">
                </div>

            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 20px; color: #34495e;">
                ì´ ê¸°ë¡ íšŸìˆ˜: <span id="totalRecordsCount">0</span>íšŒ
            </div>

            <div class="stats-chart">
                <h4>1. ê²Œì„ êµ¬ë¶„ í†µê³„ (ì •ê·œ/ë²ˆì™¸ ë¹„ìœ¨)</h4>
                <div id="typeStats">
                </div>
            </div>

            <div class="stats-chart">
                <h4>2. ì»¤í”¼ êµ¬ë§¤ì í†µê³„ (ì „ì²´ ê¸°ë¡)</h4>
                <div id="buyerStatsAll">
                </div>
            </div>
            
            <div class="stats-chart">
                <h4>3. ì»¤í”¼ êµ¬ë§¤ì í†µê³„ (ì •ê·œ ê²Œì„ í•œì •)</h4>
                <div id="buyerStatsRegular">
                </div>
            </div>
            
            <div class="stats-chart">
                <h4>4. ì»¤í”¼ êµ¬ë§¤ì í†µê³„ (ë²ˆì™¸ ê²Œì„ í•œì •)</h4>
                <div id="buyerStatsExtra">
                </div>
            </div>

            <p style="font-size: 0.9em; color: #777;">**ë§‰ëŒ€ ê·¸ë˜í”„ëŠ” ê° ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ íšŸìˆ˜ê°€ ê°€ì¥ ë§ì€ ì‚¬ëŒì„ 100% ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</p>
        </div>
        
    </div>

    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- 1. Firebase ì„¤ì • ë° ì´ˆê¸°í™” (ê³ ê°ë‹˜ì˜ ê°’) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAf369AzoQLAHD8_Bcck_j3fB2fgQUnglg",
            authDomain: "coffee-bf111.firebaseapp.com",
            databaseURL: "https://coffee-bf111-default-rtdb.firebaseio.com",
            projectId: "coffee-bf111",
            storageBucket: "coffee-bf111.firebasestorage.app",
            messagingSenderId: "1049977125059",
            appId: "1:1049977125059:web:1fb0d5eeb7bbdac2dc4a76",
            measurementId: "G-ZG06GF8VR7"
        };
        
        // Firebase ì•± ì´ˆê¸°í™” ë° DB ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        const recordsRef = ref(db, 'coffeeRecords'); 

        let recordsData = []; // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ë¼ì´ë¸Œ ë°ì´í„°ë¥¼ ë‹´ì„ ì „ì—­ ë°°ì—´
        
        // --- ë°ì´í„° ì •ì˜ ì˜ì—­ ---
        const kakaopayUrls = {
            'í™©ë¯¼êµ¬': 'https://qr.kakaopay.com/Ej9Ik0WyG',
            'ì •ì§€í¬': 'https://qr.kakaopay.com/FIp8Ra2lC',
            'êµ¬ë³´ëŒ': 'https://qr.kakaopay.com/Ej7mzDtSG',
            'ê¹€í˜œë¹ˆ': 'https://qr.kakaopay.com/FL7mOkDUS',
            'ì •ë¯¼ê²½': 'https://qr.kakaopay.com/Ej7j0OW09',
            'ë°•ì„œì—°': 'https://qr.kakaopay.com/FX8cFjPmp',
            'ë°•ì„±í¬': 'https://qr.kakaopay.com/FTLnTMuOI'
        };
        const memberNames = ['êµ¬ë³´ëŒ', 'ê¹€í˜œë¹ˆ', 'ë°•ì„œì—°', 'ë°•ì„±í¬', 'ì •ë¯¼ê²½', 'ì •ì§€í¬', 'í™©ë¯¼êµ¬'];

        // --- ì „ì—­ í•¨ìˆ˜ ì •ì˜ (window ê°ì²´ì— ë°”ì¸ë”©) ---
        window.getRecords = function() {
            return recordsData;
        }

        // â­ íƒ­ ì „í™˜ í•¨ìˆ˜ â­
        window.openTab = function(tabName, elmnt) {
            // 1. ëª¨ë“  .tab-content ìˆ¨ê¸°ê¸°
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            // 2. ëª¨ë“  .tab-buttonì˜ active í´ë˜ìŠ¤ ì œê±°
            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            // 3. í˜„ì¬ íƒ­ ì½˜í…ì¸  ë° ë²„íŠ¼ í™œì„±í™”
            const currentContent = document.getElementById(tabName);
            if (currentContent) {
                currentContent.classList.add("active");
            }
            elmnt.classList.add("active");
            
            // 4. í†µê³„ íƒ­ì´ ì—´ë¦´ ë•Œ í†µê³„ë¥¼ ë‹¤ì‹œ ë Œë”ë§
            if (tabName === 'statsContent') {
                renderStats(); 
            }
        }
        
        // --- Firebase ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (í•µì‹¬) ---
        function listenForRecords() {
            onValue(recordsRef, (snapshot) => {
                recordsData = [];
                const data = snapshot.val();
                
                if (data) {
                    recordsData = Object.keys(data).map(key => ({
                        ...data[key],
                        firebaseId: key 
                    })).sort((a, b) => b.timestamp - a.timestamp); 
                }
                
                renderRecordsList(); 
                // í†µê³„ íƒ­ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°ì—ë§Œ ë Œë”ë§
                if(document.getElementById('statsContent').classList.contains('active')) {
                    renderStats();
                }

            }, (error) => {
                console.error("Firebase ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                alert("âš ï¸ ê¸°ë¡ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.");
            });
        }

        function initializeRecordBuyer() {
            const container = document.getElementById('recordBuyerCheckboxes');
            if (!container) return; 
            
            const sortedMembers = [...memberNames].sort(); 

            sortedMembers.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginRight = '10px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'buyer-' + name;
                checkbox.name = 'recordBuyer';
                checkbox.value = name;
                
                const label = document.createElement('label');
                label.htmlFor = 'buyer-' + name;
                label.textContent = name;
                label.style.marginLeft = '5px';

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
        }

        // HTML ë¬¸ì„œ ë¡œë“œ í›„ ì‹¤í–‰ 
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const recordDateInput = document.getElementById('recordDate');
                if (recordDateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    recordDateInput.value = today;
                }
                
                initializeRecordBuyer();
                
                listenForRecords(); // í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë”© ë° ë¦¬ìŠ¤ë„ˆ ì‹œì‘

            } catch (error) {
                console.error("ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("âš ï¸ ì•± ì´ˆê¸°í™” ì˜¤ë¥˜. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.");
            }
        });

        // --- ì†¡ê¸ˆ ë° ê³„ì‚°ê¸° ê¸°ëŠ¥ ---
        window.goToKakaopay = function(personName) {
            const url = kakaopayUrls[personName];
            if (url) {
                window.location.href = url;
            } else {
                alert(personName + 'ë‹˜ì˜ ì†¡ê¸ˆ ì½”ë“œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        }

        window.calculateSplit = function() {
            const totalAmountInput = document.getElementById('totalAmount');
            const numPeopleInput = document.getElementById('numPeople');
            const resultDiv = document.getElementById('calculationResult');

            const rawTotalAmount = parseInt(totalAmountInput.value);
            const numPeople = parseInt(numPeopleInput.value);

            if (isNaN(rawTotalAmount) || isNaN(numPeople) || rawTotalAmount <= 0 || numPeople <= 0) {
                resultDiv.innerHTML = "ì´ ê¸ˆì•¡ê³¼ ì¸ì›ìˆ˜ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                return;
            }
            
            const totalAmount = Math.ceil(rawTotalAmount / 100) * 100;
            
            let roundingNote = "";
            if (rawTotalAmount !== totalAmount) {
                roundingNote = `<br><small>ì…ë ¥í•˜ì‹  ${rawTotalAmount.toLocaleString()}ì›ì´ 100ì› ë‹¨ìœ„ ì˜¬ë¦¼ë˜ì–´ ${totalAmount.toLocaleString()}ì›ìœ¼ë¡œ ì‚°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</small>`;
            } else if (rawTotalAmount === totalAmount && rawTotalAmount % 100 === 0) {
                 roundingNote = `<br><small>ì´ ê¸ˆì•¡ ${totalAmount.toLocaleString()}ì› ê¸°ì¤€ ë¶„ë°°ì…ë‹ˆë‹¤.</small>`;
            }

            const basicAmount = Math.floor(totalAmount / numPeople / 100) * 100;
            const remainder = totalAmount - (basicAmount * numPeople);
            const extraPeople = remainder / 100; 
            const higherAmount = basicAmount + 100;
            const lowerAmount = basicAmount;

            let resultText = "";
            
            if (extraPeople > 0 && extraPeople <= numPeople) {
                const lowerPeople = numPeople - extraPeople;
                
                if (lowerPeople === 0 && basicAmount === higherAmount - 100) {
                     resultText = `**ëª¨ë‘** ${basicAmount.toLocaleString()}ì›`;
                } else {
                     resultText = `**${extraPeople}ëª…** ${higherAmount.toLocaleString()}ì›, **${lowerPeople}ëª…** ${lowerAmount.toLocaleString()}ì›`;
                }
            } else if (totalAmount > 0 && totalAmount < 100 && numPeople >= 1) {
                const peopleFor100 = Math.ceil(totalAmount / 100);
                const peopleFor0 = numPeople - peopleFor100;

                resultText = `**${peopleFor100}ëª…** 100ì›, **${peopleFor0}ëª…** 0ì›`;
            } else {
                 resultText = `**ëª¨ë‘** ${basicAmount.toLocaleString()}ì›`;
            }

            resultDiv.innerHTML = resultText + roundingNote;
        }

        // --- ê¸°ë¡ ì €ì¥ ê¸°ëŠ¥ (V9 push ì‚¬ìš©) ---
        window.saveRecord = function() {
            const type = document.getElementById('recordType').value;
            const date = document.getElementById('recordDate').value;
            const checkedBuyers = Array.from(document.querySelectorAll('input[name="recordBuyer"]:checked'))
                                       .map(cb => cb.value);
            const game = document.getElementById('recordGame').value.trim();

            if (!date || checkedBuyers.length === 0 || !game) {
                alert('ë‚ ì§œ, ì»¤í”¼ êµ¬ë§¤ì (ìµœì†Œ 1ëª…), ë¬´ìŠ¨ ê²Œì„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            const newRecord = {
                type: type,
                date: date,
                buyer: checkedBuyers, 
                game: game,
                timestamp: Date.now() 
            };

            // Firebaseì— ì €ì¥
            push(recordsRef, newRecord) 
                .then(() => {
                    alert(`âœ… ê¸°ë¡ì´ í´ë¼ìš°ë“œ(Firebase)ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ê¸°í™”ë©ë‹ˆë‹¤.`);
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('recordGame').value = ''; 
                    document.querySelectorAll('input[name="recordBuyer"]:checked').forEach(cb => cb.checked = false);
                    document.getElementById('recordType').value = 'ë²ˆì™¸';
                })
                .catch(error => {
                    alert(`âš ï¸ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
                    console.error("Firebase ì €ì¥ ì˜¤ë¥˜:", error);
                });
        }

        // --- ê¸°ë¡ ì‚­ì œ ê¸°ëŠ¥ (V9 remove ì‚¬ìš©) ---
        window.deleteRecord = function(firebaseId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í´ë¼ìš°ë“œ ë°ì´í„°ì—ì„œ ì˜êµ¬ ì‚­ì œë˜ë©°, ëª¨ë“  ê¸°ê¸°ì— ë°˜ì˜ë©ë‹ˆë‹¤.)')) {
                return;
            }

            const recordToDeleteRef = ref(db, 'coffeeRecords/' + firebaseId);
            remove(recordToDeleteRef) 
                .then(() => {
                    alert('âœ… ê¸°ë¡ì´ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch(error => {
                    alert(`âš ï¸ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                    console.error("Firebase ì‚­ì œ ì˜¤ë¥˜:", error);
                });
        }

        // --- ê¸°ë¡ ëª©ë¡ ë Œë”ë§ ---
        function renderRecordsList() {
            const recordsListElement = document.getElementById('recordsList');
            if (!recordsListElement) return; 

            recordsListElement.innerHTML = '';
            
            const records = getRecords(); 

            if (records.length === 0) {
                recordsListElement.innerHTML = '<li>ì•„ì§ ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            records.forEach(record => {
                const listItem = document.createElement('li');
                
                const dateParts = record.date.split('-'); 
                const dateDisplay = `${dateParts[1]}/${dateParts[2]}`; 
                
                const buyerDisplay = Array.isArray(record.buyer) ? record.buyer.join(', ') : record.buyer; 
                
                listItem.innerHTML = `
                    <div>
                        [<strong>${record.type}</strong>] ${dateDisplay} - **${buyerDisplay}** ë‹¹ì²¨! <br>
                        <small>${record.game}</small>
                    </div>
                    <button class="delete-button" onclick="deleteRecord('${record.firebaseId}')">ì‚­ì œ</button>
                `;
                recordsListElement.appendChild(listItem);
            });
        }

        // --- í†µê³„ ê¸°ëŠ¥ ---
        function getBuyerCounts(records) {
            const buyerCounts = memberNames.reduce((acc, name) => {
                acc[name] = 0; 
                return acc;
            }, {});
            
            records.forEach(record => {
                if (Array.isArray(record.buyer)) {
                    record.buyer.forEach(buyerName => {
                        buyerCounts[buyerName] = (buyerCounts[buyerName] || 0) + 1;
                    });
                } else if (record.buyer) {
                    buyerCounts[record.buyer] = (buyerCounts[record.buyer] || 0) + 1;
                }
            });
            return buyerCounts;
        }

        function renderStats() {
            const allRecords = getRecords();
            const totalCount = allRecords.length;
            const totalRecordsCountElement = document.getElementById('totalRecordsCount');
            if (totalRecordsCountElement) totalRecordsCountElement.textContent = totalCount;
            
            if (totalCount === 0) {
                const clearStats = (id) => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '<p>ê¸°ë¡ì´ ì—†ì–´ í†µê³„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                };
                clearStats('typeStats');
                clearStats('buyerStatsAll');
                clearStats('buyerStatsRegular');
                clearStats('buyerStatsExtra');
                
                const latestBuyerEl = document.getElementById('latestRegularBuyer');
                if (latestBuyerEl) latestBuyerEl.innerHTML = '<span>ìµœê·¼ ì •ê·œ ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }
            
            const regularRecords = allRecords.filter(r => r.type === 'ì •ê·œ').sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestRegularBuyerDiv = document.getElementById('latestRegularBuyer');
            
            if (latestRegularBuyerDiv) {
                if (regularRecords.length > 0) {
                    const latestBuyer = Array.isArray(regularRecords[0].buyer) ? regularRecords[0].buyer.join(', ') : regularRecords[0].buyer;
                    const latestDate = regularRecords[0].date;
                    latestRegularBuyerDiv.innerHTML = `ğŸŒŸ **ìµœê·¼ ì •ê·œ ê²Œì„ êµ¬ë§¤ì:** <span style="color:#e74c3c;">${latestBuyer}</span> (${latestDate})`;
                } else {
                    latestRegularBuyerDiv.innerHTML = '<span>ìµœê·¼ ì •ê·œ ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                }
            }

            const typeCounts = allRecords.reduce((acc, record) => {
                acc[record.type] = (acc[record.type] || 0) + 1;
                return acc;
            }, {});
            drawBarChart('typeStats', typeCounts, totalCount, 'regular', {'ì •ê·œ': 'regular', 'ë²ˆì™¸': 'extra'});

            const buyerCountsAll = getBuyerCounts(allRecords);
            drawBarChart('buyerStatsAll', buyerCountsAll, totalCount, 'buyer-all');
            
            const buyerCountsRegular = getBuyerCounts(regularRecords);
            if (regularRecords.length > 0) {
                 drawBarChart('buyerStatsRegular', buyerCountsRegular, regularRecords.length, 'buyer-regular');
            } else {
                 const buyerStatsRegularEl = document.getElementById('buyerStatsRegular');
                 if (buyerStatsRegularEl) buyerStatsRegularEl.innerHTML = '<p>ì •ê·œ ê²Œì„ ê¸°ë¡ì´ ì—†ì–´ í†µê³„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            const extraRecords = allRecords.filter(r => r.type === 'ë²ˆì™¸');
            const buyerCountsExtra = getBuyerCounts(extraRecords);
            if (extraRecords.length > 0) {
                 drawBarChart('buyerStatsExtra', buyerCountsExtra, extraRecords.length, 'buyer-extra');
            } else {
                 const buyerStatsExtraEl = document.getElementById('buyerStatsExtra');
                 if (buyerStatsExtraEl) buyerStatsExtraEl.innerHTML = '<p>ë²ˆì™¸ ê²Œì„ ê¸°ë¡ì´ ì—†ì–´ í†µê³„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        function drawBarChart(elementId, dataCounts, totalCount, baseClass, colorMap = {}) {
            const container = document.getElementById(elementId);
            if (!container) return; 
            
            container.innerHTML = ''; 

            const sortedKeys = Object.keys(dataCounts).sort((a, b) => dataCounts[b] - dataCounts[a]);

            const maxCount = Math.max(...Object.values(dataCounts), 1); 

            sortedKeys.forEach(key => {
                const count = dataCounts[key];
                const percentage = count > 0 ? (count / maxCount) * 100 : 0;
                const barColorClass = colorMap[key] || baseClass;

                if (count === 0 && elementId.includes('buyerStats')) {
                    return; 
                }

                const chartItem = document.createElement('div');
                chartItem.innerHTML = `
                    <p style="margin: 5px 0 0; font-size: 0.9em;">**${key}** (${count}íšŒ)</p>
                    <div class="chart-bar-container">
                        <div class="chart-bar ${barColorClass}" style="width: ${percentage}%;">
                            ${count > 0 ? count + 'íšŒ' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(chartItem);
            });
        }
        
    </script>
</body>
</html>
